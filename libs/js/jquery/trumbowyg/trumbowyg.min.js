/*
 MIT
 @author Alexandre Demode (Alex-D)
         Twitter : @AlexandreDemode
         Website : alex-d.fr
*/
jQuery.trumbowyg={langs:{en:{viewHTML:"View HTML",undo:"Undo",redo:"Redo",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",del:"Deleted",superscript:"Superscript",subscript:"Subscript",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image",link:"Link",createLink:"Insert link",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",
justifyRight:"Align Right",justifyFull:"Align Justify",horizontalRule:"Insert horizontal rule",removeformat:"Remove format",fullscreen:"Fullscreen",close:"Close",submit:"Confirm",reset:"Cancel",required:"Required",description:"Description",title:"Title",text:"Text",target:"Target"}},plugins:{},svgPath:null,hideButtonTexts:null};
(function(p,k,r,e){e.fn.trumbowyg=function(a,b){if(a===Object(a)||!a)return this.each(function(){e(this).data("trumbowyg")||e(this).data("trumbowyg",new q(this,a))});if(1===this.length)try{var c=e(this).data("trumbowyg");switch(a){case "execCmd":return c.execCmd(b.cmd,b.param,b.forceCss);case "openModal":return c.openModal(b.title,b.content);case "closeModal":return c.closeModal();case "openModalInsert":return c.openModalInsert(b.title,b.fields,b.callback);case "saveRange":return c.saveRange();case "getRange":return c.range;
case "getRangeText":return c.getRangeText();case "restoreRange":return c.restoreRange();case "enable":return c.toggleDisable(!1);case "disable":return c.toggleDisable(!0);case "destroy":return c.destroy();case "empty":return c.empty();case "html":return c.html(b)}}catch(d){}return!1};var q=function(a,b){var c=this;c.doc=a.ownerDocument||r;c.$ta=e(a);c.$c=e(a);b=b||{};c.lang=null!=b.lang||null!=e.trumbowyg.langs[b.lang]?e.extend(!0,{},e.trumbowyg.langs.en,e.trumbowyg.langs[b.lang]):e.trumbowyg.langs.en;
c.hideButtonTexts=null!=e.trumbowyg.hideButtonTexts?e.trumbowyg.hideButtonTexts:b.hideButtonTexts;var d=null!=e.trumbowyg.svgPath?e.trumbowyg.svgPath:b.svgPath;c.hasSvg=!1!==d;c.svgPath=c.doc.querySelector("base")?k.location.href.split("#")[0]:"";if(0===e("#trumbowyg-icons",c.doc).length&&!1!==d){if(null==d)try{throw Error();}catch(f){var g=f.stack.split("\n"),h;for(h in g)if(g[h].match(/http[s]?:\/\//)){d=g[Number(h)].match(/((http[s]?:\/\/.+\/)([^\/]+\.js))(\?.*)?:/)[1].split("/");d.pop();d=d.join("/")+
"/ui/icons.svg";break}}var l=c.doc.createElement("div");l.id="trumbowyg-icons";c.doc.body.insertBefore(l,c.doc.body.childNodes[0]);e.ajax({async:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"xml",url:d,data:null,beforeSend:null,complete:null,success:function(a){l.innerHTML=(new XMLSerializer).serializeToString(a.documentElement)}})}d=c.lang.header;g=function(){return(k.chrome||k.Intl&&Intl.v8BreakIterator)&&"CSS"in k};c.btnsDef={viewHTML:{fn:"toggle"},undo:{isSupported:g,
key:"Z"},redo:{isSupported:g,key:"Y"},p:{fn:"formatBlock"},blockquote:{fn:"formatBlock"},h1:{fn:"formatBlock",title:d+" 1"},h2:{fn:"formatBlock",title:d+" 2"},h3:{fn:"formatBlock",title:d+" 3"},h4:{fn:"formatBlock",title:d+" 4"},subscript:{tag:"sub"},superscript:{tag:"sup"},bold:{key:"B",tag:"b"},italic:{key:"I",tag:"i"},underline:{tag:"u"},strikethrough:{tag:"strike"},strong:{fn:"bold",key:"B"},em:{fn:"italic",key:"I"},del:{fn:"strikethrough"},createLink:{key:"K",tag:"a"},unlink:{},insertImage:{},
justifyLeft:{tag:"left",forceCss:!0},justifyCenter:{tag:"center",forceCss:!0},justifyRight:{tag:"right",forceCss:!0},justifyFull:{tag:"justify",forceCss:!0},unorderedList:{fn:"insertUnorderedList",tag:"ul"},orderedList:{fn:"insertOrderedList",tag:"ol"},horizontalRule:{fn:"insertHorizontalRule"},removeformat:{},fullscreen:{"class":"trumbowyg-not-disable"},close:{fn:"destroy","class":"trumbowyg-not-disable"},formatting:{dropdown:"p blockquote h1 h2 h3 h4".split(" "),ico:"p"},link:{dropdown:["createLink",
"unlink"]}};c.o=e.extend(!0,{},{lang:"en",fixedBtnPane:!1,fixedFullWidth:!1,autogrow:!1,prefix:"trumbowyg-",semantic:!0,resetCss:!1,removeformatPasted:!1,tagsToRemove:[],btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em","del"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]},btns:[["viewHTML"],["undo","redo"],["formatting"],"btnGrp-semantic",["superscript","subscript"],["link"],["insertImage"],"btnGrp-justify",
"btnGrp-lists",["horizontalRule"],["removeformat"],["fullscreen"]],btnsDef:{},inlineElementsSelector:"a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u",pasteHandlers:[],imgDblClickHandler:function(){var a=e(this),b=a.attr("src");0===b.indexOf("data:image")&&(b="(Base64)");c.openModalInsert(c.lang.insertImage,{url:{label:"URL",value:b,required:!0},alt:{label:c.lang.description,value:a.attr("alt")}},function(b){"(Base64)"!==b.src&&a.attr({src:b.src});
a.attr({alt:b.alt});return!0});return!1},plugins:{}},b);c.disabled=c.o.disabled||"TEXTAREA"===a.nodeName&&a.disabled;b.btns?c.o.btns=b.btns:c.o.semantic||(c.o.btns[4]="btnGrp-design");e.each(c.o.btnsDef,function(a,b){c.addBtnDef(a,b)});c.eventNamespace="trumbowyg-event";c.keys=[];c.tagToButton={};c.tagHandlers=[];c.pasteHandlers=[].concat(c.o.pasteHandlers);c.isIE=-1!==p.userAgent.indexOf("MSIE")||-1!==p.appVersion.indexOf("Trident/");c.init()};q.prototype={init:function(){var a=this;a.height=a.$ta.height();
a.initPlugins();try{a.doc.execCommand("enableObjectResizing",!1,!1),a.doc.execCommand("defaultParagraphSeparator",!1,"p")}catch(b){}a.buildEditor();a.buildBtnPane();a.fixedBtnPaneEvents();a.buildOverlay();setTimeout(function(){a.disabled&&a.toggleDisable(!0);a.$c.trigger("tbwinit")})},addBtnDef:function(a,b){this.btnsDef[a]=b},buildEditor:function(){var a=this,b=a.o.prefix,c="";a.$box=e("<div/>",{"class":b+"box "+b+"editor-visible "+b+a.o.lang+" trumbowyg"});a.isTextarea=a.$ta.is("textarea");a.isTextarea?
(c=a.$ta.val(),a.$ed=e("<div/>"),a.$box.insertAfter(a.$ta).append(a.$ed,a.$ta)):(a.$ed=a.$ta,c=a.$ed.html(),a.$ta=e("<textarea/>",{name:a.$ta.attr("id"),height:a.height}).val(c),a.$box.insertAfter(a.$ed).append(a.$ta,a.$ed),a.syncCode());a.$ta.addClass(b+"textarea").attr("tabindex",-1);a.$ed.addClass(b+"editor").attr({contenteditable:!0,dir:a.lang._dir||"ltr"}).html(c);a.o.tabindex&&a.$ed.attr("tabindex",a.o.tabindex);a.$c.is("[placeholder]")&&a.$ed.attr("placeholder",a.$c.attr("placeholder"));a.o.resetCss&&
a.$ed.addClass(b+"reset-css");a.o.autogrow||a.$ta.add(a.$ed).css({height:a.height});a.semanticCode();var d=!1,f=!1,g,c=a.isIE?"keyup":"input";a.$ed.on("dblclick","img",a.o.imgDblClickHandler).on("keydown",function(b){if(b.ctrlKey){d=!0;b=a.keys[String.fromCharCode(b.which).toUpperCase()];try{return a.execCmd(b.fn,b.param),!1}catch(c){}}}).on("compositionstart compositionupdate",function(){f=!0}).on(c+" compositionend",function(b){if("compositionend"===b.type)f=!1;else if(f)return;var c=b.which;37<=
c&&40>=c||(!b.ctrlKey||89!==c&&90!==c?d||17===c?"undefined"===typeof b.which&&a.semanticCode(!1,!1,!0):(a.semanticCode(!1,13===c),a.$c.trigger("tbwchange")):a.$c.trigger("tbwchange"),setTimeout(function(){d=!1},200))}).on("mouseup keydown keyup",function(){clearTimeout(g);g=setTimeout(function(){a.updateButtonPaneStatus()},50)}).on("focus blur",function(c){a.$c.trigger("tbw"+c.type);"blur"===c.type&&e("."+b+"active-button",a.$btnPane).removeClass(b+"active-button "+b+"active")}).on("cut",function(){setTimeout(function(){a.semanticCode(!1,
!0);a.$c.trigger("tbwchange")},0)}).on("paste",function(b){if(a.o.removeformatPasted){b.preventDefault();try{var c=k.clipboardData.getData("Text");try{a.doc.selection.createRange().pasteHTML(c)}catch(d){a.doc.getSelection().getRangeAt(0).insertNode(a.doc.createTextNode(c))}}catch(f){a.execCmd("insertText",(b.originalEvent||b).clipboardData.getData("text/plain"))}}e.each(a.pasteHandlers,function(a,c){c(b)});setTimeout(function(){a.semanticCode(!1,!0);a.$c.trigger("tbwpaste",b)},0)});a.$ta.on("keyup paste",
function(){a.$c.trigger("tbwchange")});a.$box.on("keydown",function(c){if(27===c.which&&1===e("."+b+"modal-box",a.$box).length)return a.closeModal(),!1})},buildBtnPane:function(){var a=this,b=a.o.prefix,c=a.$btnPane=e("<div/>",{"class":b+"button-pane"});e.each(a.o.btns,function(d,f){try{var g=f.split("btnGrp-");null!=g[1]&&(f=a.o.btnsGrps[g[1]])}catch(h){}e.isArray(f)||(f=[f]);var l=e("<div/>",{"class":b+"button-group "+(0<=f.indexOf("fullscreen")?b+"right":"")});e.each(f,function(b,c){try{var d;
a.isSupportedBtn(c)&&(d=a.buildBtn(c));l.append(d)}catch(e){}});c.append(l)});a.$box.prepend(c)},buildBtn:function(a){var b=this,c=b.o.prefix,d=b.btnsDef[a],f=d.dropdown,g=null!=d.hasIcon?d.hasIcon:!0,h=b.lang[a]||a,g=e("<button/>",{type:"button","class":c+a+"-button "+(d["class"]||"")+(g?"":" "+c+"textual-button"),html:b.hasSvg&&g?'<svg><use xlink:href="'+b.svgPath+"#"+c+(d.ico||a).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>':b.hideButtonTexts?"":d.text||d.title||b.lang[a]||a,title:(d.title||
d.text||h)+(d.key?" (Ctrl + "+d.key+")":""),tabindex:-1,mousedown:function(){f&&!e("."+a+"-"+c+"dropdown",b.$box).is(":hidden")||e("body",b.doc).trigger("mousedown");if(b.$btnPane.hasClass(c+"disable")&&!e(this).hasClass(c+"active")&&!e(this).hasClass(c+"not-disable"))return!1;b.execCmd((f?"dropdown":!1)||d.fn||a,d.param||a,d.forceCss||!1);return!1}});if(f){g.addClass(c+"open-dropdown");var h=c+"dropdown",l=e("<div/>",{"class":h+"-"+a+" "+h+" "+c+"fixed-top","data-dropdown":a});e.each(f,function(a,
c){b.btnsDef[c]&&b.isSupportedBtn(c)&&l.append(b.buildSubBtn(c))});b.$box.append(l.hide())}else d.key&&(b.keys[d.key]={fn:d.fn||a,param:d.param||a});f||(b.tagToButton[(d.tag||a).toLowerCase()]=a);return g},buildSubBtn:function(a){var b=this,c=b.o.prefix,d=b.btnsDef[a],f=null!=d.hasIcon?d.hasIcon:!0;d.key&&(b.keys[d.key]={fn:d.fn||a,param:d.param||a});b.tagToButton[(d.tag||a).toLowerCase()]=a;return e("<button/>",{type:"button","class":c+a+"-dropdown-button"+(d.ico?" "+c+d.ico+"-button":""),html:b.hasSvg&&
f?'<svg><use xlink:href="'+b.svgPath+"#"+c+(d.ico||a).replace(/([A-Z]+)/g,"-$1").toLowerCase()+'"/></svg>'+(d.text||d.title||b.lang[a]||a):d.text||d.title||b.lang[a]||a,title:d.key?" (Ctrl + "+d.key+")":null,style:d.style||null,mousedown:function(){e("body",b.doc).trigger("mousedown");b.execCmd(d.fn||a,d.param||a,d.forceCss||!1);return!1}})},isSupportedBtn:function(a){try{return this.btnsDef[a].isSupported()}catch(b){}return!0},buildOverlay:function(){return this.$overlay=e("<div/>",{"class":this.o.prefix+
"overlay"}).css({top:this.$btnPane.outerHeight(),height:this.$ed.outerHeight()+1+"px"}).appendTo(this.$box)},showOverlay:function(){e(k).trigger("scroll");this.$overlay.fadeIn(200);this.$box.addClass(this.o.prefix+"box-blur")},hideOverlay:function(){this.$overlay.fadeOut(50);this.$box.removeClass(this.o.prefix+"box-blur")},fixedBtnPaneEvents:function(){var a=this,b=a.o.fixedFullWidth,c=a.$box;a.o.fixedBtnPane&&(a.isFixed=!1,e(k).on("scroll."+a.eventNamespace+" resize."+a.eventNamespace,function(){if(c){a.syncCode();
var d=e(k).scrollTop(),f=c.offset().top+1,g=a.$btnPane,h=g.outerHeight()-2;0<d-f&&0>d-f-a.height?(a.isFixed||(a.isFixed=!0,g.css({position:"fixed",top:0,left:b?"0":"auto",zIndex:7}),e([a.$ta,a.$ed]).css({marginTop:g.height()})),g.css({width:b?"100%":c.width()-1+"px"}),e("."+a.o.prefix+"fixed-top",c).css({position:b?"fixed":"absolute",top:b?h:h+(d-f)+"px",zIndex:15})):a.isFixed&&(a.isFixed=!1,g.removeAttr("style"),e([a.$ta,a.$ed]).css({marginTop:0}),e("."+a.o.prefix+"fixed-top",c).css({position:"absolute",
top:h}))}}))},toggleDisable:function(a){var b=this.o.prefix;(this.disabled=a)?this.$ta.attr("disabled",!0):this.$ta.removeAttr("disabled");this.$box.toggleClass(b+"disabled",a);this.$ed.attr("contenteditable",!a)},destroy:function(){var a=this.o.prefix,b=this.height;this.isTextarea?this.$box.after(this.$ta.css({height:b}).val(this.html()).removeClass(a+"textarea").show()):this.$box.after(this.$ed.css({height:b}).removeClass(a+"editor").removeAttr("contenteditable").html(this.html()).show());this.$ed.off("dblclick",
"img");this.destroyPlugins();this.$box.remove();this.$c.removeData("trumbowyg");e("body").removeClass(a+"body-fullscreen");this.$c.trigger("tbwclose");e(k).off("scroll."+this.eventNamespace+" resize."+this.eventNamespace)},empty:function(){this.$ta.val("");this.syncCode(!0)},toggle:function(){var a=this,b=a.o.prefix;a.semanticCode(!1,!0);setTimeout(function(){a.doc.activeElement.blur();a.$box.toggleClass(b+"editor-hidden "+b+"editor-visible");a.$btnPane.toggleClass(b+"disable");e("."+b+"viewHTML-button",
a.$btnPane).toggleClass(b+"active");a.$box.hasClass(b+"editor-visible")?a.$ta.attr("tabindex",-1):a.$ta.removeAttr("tabindex")},0)},dropdown:function(a){var b=this,c=b.doc,d=b.o.prefix,f=e("[data-dropdown="+a+"]",b.$box);a=e("."+d+a+"-button",b.$btnPane);var g=f.is(":hidden");e("body",c).trigger("mousedown");g&&(g=a.offset().left,a.addClass(d+"active"),f.css({position:"absolute",top:a.offset().top-b.$btnPane.offset().top+a.outerHeight(),left:b.o.fixedFullWidth&&b.isFixed?g+"px":g-b.$btnPane.offset().left+
"px"}).show(),e(k).trigger("scroll"),e("body",c).on("mousedown."+b.eventNamespace,function(a){f.is(a.target)||(e("."+d+"dropdown",c).hide(),e("."+d+"active",c).removeClass(d+"active"),e("body",c).off("mousedown."+b.eventNamespace))}))},html:function(a){return null!=a?(this.$ta.val(a),this.syncCode(!0),this):this.$ta.val()},syncTextarea:function(){this.$ta.val(0<this.$ed.text().trim().length||0<this.$ed.find("hr,img,embed,iframe,input").length?this.$ed.html():"")},syncCode:function(a){!a&&this.$ed.is(":visible")?
this.syncTextarea():this.$ed.html(this.$ta.val());this.o.autogrow&&(this.height=this.$ed.height(),this.height!==this.$ta.css("height")&&(this.$ta.css({height:this.height}),this.$c.trigger("tbwresize")))},semanticCode:function(a,b,c){var d=this;d.saveRange();d.syncCode(a);e(d.o.tagsToRemove.join(","),d.$ed).remove();if(d.o.semantic){d.semanticTag("b","strong");d.semanticTag("i","em");if(b){var f=d.o.inlineElementsSelector,g=":not("+f+")";d.$ed.contents().filter(function(){return 3===this.nodeType&&
0<this.nodeValue.trim().length}).wrap("<span data-tbw/>");var h=function(a){if(0!==a.length){a=a.nextUntil(g).addBack().wrapAll("<p/>").parent();var b=a.nextAll(f).first();a.next("br").remove();h(b)}};h(d.$ed.children(f).first());d.semanticTag("div","p",!0);d.$ed.find("p").filter(function(){return d.range&&this===d.range.startContainer?!1:0===e(this).text().trim().length&&0===e(this).children().not("br,span").length}).contents().unwrap();e("[data-tbw]",d.$ed).contents().unwrap();d.$ed.find("p:empty").remove()}c||
d.restoreRange();d.syncTextarea()}},semanticTag:function(a,b,c){e(a,this.$ed).each(function(){var a=e(this);a.wrap("<"+b+"/>");c&&e.each(a.prop("attributes"),function(){a.parent().attr(this.name,this.value)});a.contents().unwrap()})},createLink:function(){for(var a=this,b=a.doc.getSelection(),c=b.focusNode,d;0>["A","DIV"].indexOf(c.nodeName);)c=c.parentNode;if(c&&"A"===c.nodeName){var f=e(c);d=f.attr("href");f.attr("title");f.attr("target");f=a.doc.createRange();f.selectNode(c);b.addRange(f)}a.saveRange();
a.openModalInsert(a.lang.createLink,{url:{label:"URL",required:!0,value:d},text:{label:a.lang.text,value:a.getRangeText()}},function(b){b=e(['<a href="',b.url,'">',b.text,"</a>"].join(""));b.attr("target","_blank");a.range.deleteContents();a.range.insertNode(b[0]);return!0})},unlink:function(){var a=this.doc.getSelection(),b=a.focusNode;if(a.isCollapsed){for(;0>["A","DIV"].indexOf(b.nodeName);)b=b.parentNode;if(b&&"A"===b.nodeName){var c=this.doc.createRange();c.selectNode(b);a.addRange(c)}}this.execCmd("unlink",
void 0,void 0,!0)},insertImage:function(){var a=this;a.saveRange();a.openModalInsert(a.lang.insertImage,{url:{label:"URL",required:!0},alt:{label:a.lang.description,value:a.getRangeText()}},function(b){a.execCmd("insertImage",b.url);e('img[src="'+b.url+'"]:not([alt])',a.$box).attr("alt",b.alt);return!0})},fullscreen:function(){var a=this.o.prefix,b=a+"fullscreen";this.$box.toggleClass(b);b=this.$box.hasClass(b);e("body").toggleClass(a+"body-fullscreen",b);e(k).trigger("scroll");this.$c.trigger("tbw"+
(b?"open":"close")+"fullscreen")},execCmd:function(a,b,c,d){d=!!d||"";"dropdown"!==a&&this.$ed.focus();try{this.doc.execCommand("styleWithCSS",!1,c||!1)}catch(e){}try{this[a+d](b)}catch(g){try{a(b)}catch(h){"insertHorizontalRule"===a?b=void 0:"formatBlock"===a&&this.isIE&&(b="<"+b+">"),this.doc.execCommand(a,!1,b),this.syncCode(),this.semanticCode(!1,!0)}"dropdown"!==a&&(this.updateButtonPaneStatus(),this.$c.trigger("tbwchange"))}},openModal:function(a,b){var c=this.o.prefix;if(0<e("."+c+"modal-box",
this.$box).length)return!1;this.saveRange();this.showOverlay();this.$btnPane.addClass(c+"disable");var d=e("<div/>",{"class":c+"modal "+c+"fixed-top"}).css({top:this.$btnPane.height()}).appendTo(this.$box);this.$overlay.one("click",function(){d.trigger("tbwcancel");return!1});var f=e("<form/>",{action:"",html:b}).on("submit",function(){d.trigger("tbwconfirm");return!1}).on("reset",function(){d.trigger("tbwcancel");return!1}),f=e("<div/>",{"class":c+"modal-box",html:f}).css({top:"-"+this.$btnPane.outerHeight()+
"px",opacity:0}).appendTo(d).animate({top:0,opacity:1},100);e("<span/>",{text:a,"class":c+"modal-title"}).prependTo(f);d.height(f.outerHeight()+10);e("input:first",f).focus();this.buildModalBtn("submit",f);this.buildModalBtn("reset",f);e(k).trigger("scroll");return d},buildModalBtn:function(a,b){var c=this.o.prefix;return e("<button/>",{"class":c+"modal-button "+c+"modal-"+a,type:a,text:this.lang[a]||a}).appendTo(e("form",b))},closeModal:function(){var a=this,b=a.o.prefix;a.$btnPane.removeClass(b+
"disable");a.$overlay.off();var c=e("."+b+"modal-box",a.$box);c.animate({top:"-"+c.height()},100,function(){c.parent().remove();a.hideOverlay()});a.restoreRange()},openModalInsert:function(a,b,c){var d=this,f=d.o.prefix,g=d.lang,h="";e.each(b,function(a,b){var c=b.label,d=b.name||a,e=b.attributes||{},k=Object.keys(e).map(function(a){return a+'="'+e[a]+'"'}).join(" ");h+='<label><input type="'+(b.type||"text")+'" name="'+d+'" value="'+(b.value||"").replace(/"/g,"&quot;")+'"'+k+'><span class="'+f+'input-infos"><span>'+
(c?g[c]?g[c]:c:g[a]?g[a]:a)+"</span></span></label>"});return d.openModal(a,h).on("tbwconfirm",function(){var a=e("form",e(this)),f=!0,g={};e.each(b,function(b,c){var h=e('input[name="'+b+'"]',a);"checkbox"===h.attr("type").toLowerCase()?g[b]=h.is(":checked"):g[b]=e.trim(h.val());c.required&&""===g[b]?(f=!1,d.addErrorOnModalField(h,d.lang.required)):c.pattern&&!c.pattern.test(g[b])&&(f=!1,d.addErrorOnModalField(h,c.patternError))});f&&(d.restoreRange(),c(g,b)&&(d.syncCode(),d.$c.trigger("tbwchange"),
d.closeModal(),e(this).off("tbwconfirm")))}).one("tbwcancel",function(){e(this).off("tbwconfirm");d.closeModal()})},addErrorOnModalField:function(a,b){var c=this.o.prefix,d=a.parent();a.on("change keyup",function(){d.removeClass(c+"input-error")});d.addClass(c+"input-error").find("input+span").append(e("<span/>",{"class":c+"msg-error",text:b}))},saveRange:function(){var a=this.doc.getSelection();this.range=null;if(a.rangeCount){var a=this.range=a.getRangeAt(0),b=this.doc.createRange();b.selectNodeContents(this.$ed[0]);
b.setEnd(a.startContainer,a.startOffset);b=(b+"").length;this.metaRange={start:b,end:b+(a+"").length}}},restoreRange:function(){var a=this.metaRange,b=this.range,c=this.doc.getSelection(),d;if(b){if(a&&a.start!==a.end){var e=0,g=[this.$ed[0]],h,l=!1,k=!1;for(d=this.doc.createRange();!k&&(h=g.pop());)if(3===h.nodeType){var m=e+h.length;!l&&a.start>=e&&a.start<=m&&(d.setStart(h,a.start-e),l=!0);l&&a.end>=e&&a.end<=m&&(d.setEnd(h,a.end-e),k=!0);e=m}else for(var m=h.childNodes,n=m.length;0<n;)--n,g.push(m[n])}c.removeAllRanges();
c.addRange(d||b)}},getRangeText:function(){return this.range+""},updateButtonPaneStatus:function(){var a=this,b=a.o.prefix,c=a.getTagsRecursive(a.doc.getSelection().focusNode),d=b+"active-button "+b+"active";e("."+b+"active-button",a.$btnPane).removeClass(d);e.each(c,function(c,g){var h=a.tagToButton[g.toLowerCase()],l=e("."+b+h+"-button",a.$btnPane);if(0<l.length)l.addClass(d);else try{var l=e("."+b+"dropdown ."+b+h+"-dropdown-button",a.$box),k=l.parent().data("dropdown");e("."+b+k+"-button",a.$box).addClass(d)}catch(m){}})},
getTagsRecursive:function(a,b){var c=this;b=b||(a&&a.tagName?[a.tagName]:[]);if(a&&a.parentNode)a=a.parentNode;else return b;var d=a.tagName;if("DIV"===d)return b;"P"===d&&""!==a.style.textAlign&&b.push(a.style.textAlign);e.each(c.tagHandlers,function(d,e){b=b.concat(e(a,c))});b.push(d);return c.getTagsRecursive(a,b)},initPlugins:function(){var a=this;a.loadedPlugins=[];e.each(e.trumbowyg.plugins,function(b,c){if(!c.shouldInit||c.shouldInit(a))c.init(a),c.tagHandler&&a.tagHandlers.push(c.tagHandler),
a.loadedPlugins.push(c)})},destroyPlugins:function(){e.each(this.loadedPlugins,function(a,b){b.destroy&&b.destroy()})}}})(navigator,window,document,jQuery);
